(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{79:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return c})),n.d(t,"rightToc",(function(){return s})),n.d(t,"default",(function(){return b}));var a=n(2),i=n(6),r=(n(0),n(91)),o={title:"Security",slug:"/guides/security"},c={unversionedId:"5_Guides/5_3_Security",id:"5_Guides/5_3_Security",isDocsHomePage:!1,title:"Security",description:"API",source:"@site/docs/5_Guides/5_3_Security.md",slug:"/guides/security",permalink:"/symfony-boilerplate/docs/guides/security",editUrl:"https://github.com/thecodingmachine/symfony-boilerplate/docs/5_Guides/5_3_Security.md",version:"current",sidebar:"docs",previous:{title:"i18n",permalink:"/symfony-boilerplate/docs/guides/i18n"},next:{title:"Validation",permalink:"/symfony-boilerplate/docs/guides/validation"}},s=[{value:"API",id:"api",children:[{value:"Authentication",id:"authentication",children:[]},{value:"Users&#39; permissions",id:"users-permissions",children:[]},{value:"Access control",id:"access-control",children:[]},{value:"CORS",id:"cors",children:[]}]},{value:"Web application",id:"web-application",children:[{value:"<code>auth</code> store",id:"auth-store",children:[]},{value:"Role hierarchy",id:"role-hierarchy",children:[]},{value:"Authenticate users",id:"authenticate-users",children:[]},{value:"Access control",id:"access-control-1",children:[]}]}],l={rightToc:s};function b(e){var t=e.components,n=Object(i.a)(e,["components"]);return Object(r.b)("wrapper",Object(a.a)({},l,n,{components:t,mdxType:"MDXLayout"}),Object(r.b)("h2",{id:"api"},"API"),Object(r.b)("p",null,"Security for the API has many scopes:"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},"Authentication and users' sessions."),Object(r.b)("li",{parentName:"ol"},"Users' permissions."),Object(r.b)("li",{parentName:"ol"},"Access control (GraphQL, Symfony routes)."),Object(r.b)("li",{parentName:"ol"},"CORS.")),Object(r.b)("h3",{id:"authentication"},"Authentication"),Object(r.b)("h4",{id:"configuration"},"Configuration"),Object(r.b)("p",null,Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://graphqlite.thecodingmachine.io/"}),"GraphQLite")," exposes three GraphQL entry points\n(you do not have to create them manually):"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},"The ",Object(r.b)("inlineCode",{parentName:"li"},"login")," mutation: takes a ",Object(r.b)("inlineCode",{parentName:"li"},"userName")," and a ",Object(r.b)("inlineCode",{parentName:"li"},"password"),". It returns a ",Object(r.b)("inlineCode",{parentName:"li"},"User")," type on success."),Object(r.b)("li",{parentName:"ol"},"The ",Object(r.b)("inlineCode",{parentName:"li"},"logout")," mutation."),Object(r.b)("li",{parentName:"ol"},"The ",Object(r.b)("inlineCode",{parentName:"li"},"me")," query: returns a ",Object(r.b)("inlineCode",{parentName:"li"},"User")," type if authenticated, null otherwise.")),Object(r.b)("p",null,"GraphQLite hooks itself to the authentication mechanisms of Symfony, but it needs some help with that task."),Object(r.b)("p",null,"For instance, we defined a ",Object(r.b)("em",{parentName:"p"},"src/api/src/Infrastructure/Security/UserProvider.php"),".\nIts goal is to tell which class represents our users and load an instance of this class according to the session's data."),Object(r.b)("p",null,"We tell Symfony that we use this custom user provider in the configuration file ",Object(r.b)("em",{parentName:"p"},"src/api/config/packages/security.yaml"),"."),Object(r.b)("p",null,"In the application, we defined that class ",Object(r.b)("em",{parentName:"p"},"src/api/src/Domain/Model/User.php")," represents our users.\nIt implements the ",Object(r.b)("inlineCode",{parentName:"p"},"UserInterface")," from Symfony."),Object(r.b)("p",null,"There are many methods to implement, but the most important ones are:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"getUsername"),': the "username" value (the user\'s email in our case).'),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"getPassword"),": the salted / encoded password (",Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/thecodingmachine/tdbm"}),"TDBM")," provides the implementation - see ",Object(r.b)("em",{parentName:"li"},"src/api/src/Domain/Model/Generated/BaseUser.php"),")."),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"getRoles"),": the Symfony permissions (e.g. ",Object(r.b)("inlineCode",{parentName:"li"},"ROLE_FOO"),", ",Object(r.b)("inlineCode",{parentName:"li"},"ROLE_BAR"),", etc.) - more on that later.")),Object(r.b)("p",null,"In the boilerplate, we have already implemented those methods! \ud83d\ude09"),Object(r.b)("h4",{id:"sessions"},"Sessions"),Object(r.b)("p",null,"We store the sessions' data in the MySQL database (",Object(r.b)("inlineCode",{parentName:"p"},"sessions")," table). We configured this behavior in the configuration\nfiles ",Object(r.b)("em",{parentName:"p"},"src/api/config/packages/framework.yaml")," and ",Object(r.b)("em",{parentName:"p"},"src/api/config/services.yaml"),". "),Object(r.b)("p",null,"The migration ",Object(r.b)("em",{parentName:"p"},"src/api/migrations/Version20200424093138.php")," generates the ",Object(r.b)("inlineCode",{parentName:"p"},"sessions")," table."),Object(r.b)("h4",{id:"session-cookie"},"Session cookie"),Object(r.b)("p",null,"On login, Symfony provides a ",Object(r.b)("inlineCode",{parentName:"p"},"PHPSESSID")," cookie to the browser. On logout or session expiration, it deletes this cookie."),Object(r.b)("p",null,"This cookie is only available on the main domain and its subdomains. For instance, if your API URL is ",Object(r.b)("inlineCode",{parentName:"p"},"https://api.foo.com"),"\nand you call the ",Object(r.b)("inlineCode",{parentName:"p"},"login")," mutation from ",Object(r.b)("inlineCode",{parentName:"p"},"https://foo.com"),", the cookie will be available. It will not be the case\nfrom ",Object(r.b)("inlineCode",{parentName:"p"},"https://bar.com"),". "),Object(r.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(r.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(r.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(r.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(r.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(r.b)("p",{parentName:"div"},"\ud83d\udce3","\xa0","\xa0","You may customize the domain thanks to the ",Object(r.b)("inlineCode",{parentName:"p"},"COOKIE_DOMAIN")," environment variable from the ",Object(r.b)("inlineCode",{parentName:"p"},"api")," service."))),Object(r.b)("h3",{id:"users-permissions"},"Users' permissions"),Object(r.b)("p",null,"In Symfony, roles (i.e., ",Object(r.b)("inlineCode",{parentName:"p"},"ROLE_FOO"),") represent users' permissions."),Object(r.b)("p",null,"In the boilerplate, we defined three hierarchical roles: administrator, merchant, and client.\nHierarchical means that:"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},"The administrator is the top-level permission: it has its access level and the merchant and client's access levels."),Object(r.b)("li",{parentName:"ol"},"A merchant has its access level but also the access level of the client."),Object(r.b)("li",{parentName:"ol"},"A client has only its access level.")),Object(r.b)("p",null,"In other words, if you limit the access to a resource to users with the merchant role,\nadministrator users can access it too but not the clients."),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml",metastring:'title="src/api/config/packages/security.yaml"',title:'"src/api/config/packages/security.yaml"'}),"role_hierarchy:\n    ROLE_ADMINISTRATOR: ROLE_MERCHANT\n    ROLE_MERCHANT: ROLE_CLIENT\n")),Object(r.b)("p",null,"As explained in the previous chapter, we implemented the ",Object(r.b)("inlineCode",{parentName:"p"},"getRoles")," method from the ",Object(r.b)("inlineCode",{parentName:"p"},"UserInterface"),".\nThis method has to return an array of string. "),Object(r.b)("p",null,"However, our users have only one role attached to them (thanks to the hierarchy).\nThat's why we always return an array of one element:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php",metastring:'title="src/api/src/Domain/Model/User.php"',title:'"src/api/src/Domain/Model/User.php"'}),"public function getRoles(): array\n{\n    return [\n        'ROLE_' . $this->getRole(),\n    ];\n}\n")),Object(r.b)("p",null,"Moreover, we create the ",Object(r.b)("inlineCode",{parentName:"p"},"Role")," enumerator, which lists our users'",Object(r.b)("inlineCode",{parentName:"p"},"role")," property's available values:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php",metastring:'title="src/api/src/Domain/Enum/Role.php"',title:'"src/api/src/Domain/Enum/Role.php"'}),"use MyCLabs\\Enum\\Enum;\n\n/**\n * @method static Role ADMINISTRATOR()\n * @method static Role MERCHANT()\n * @method static Role CLIENT()\n */\nfinal class Role extends Enum\n{\n    private const ADMINISTRATOR = 'ADMINISTRATOR';\n    private const MERCHANT      = 'MERCHANT';\n    private const CLIENT        = 'CLIENT';\n}\n")),Object(r.b)("p",null,"These values don't have the prefix ",Object(r.b)("inlineCode",{parentName:"p"},"ROLE_")," because\nwe don't want to store Symfony specific information in the ",Object(r.b)("inlineCode",{parentName:"p"},"users")," table. "),Object(r.b)("p",null,"Yet, this prefix is mandatory because otherwise, Symfony will not recognize the permission."),Object(r.b)("p",null,"That's why we prefix the role whenever we interact with Symfony in our code:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php"}),"@Security(\"is_granted('ROLE_ADMINISTRATOR')\")\n")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php"}),"$this->security->isGranted(Role::getSymfonyRole(Role::MERCHANT()));\n")),Object(r.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(r.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(r.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(r.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(r.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(r.b)("p",{parentName:"div"},"\ud83d\udce3","\xa0","\xa0","A user ",Object(r.b)("strong",{parentName:"p"},"must have one role"),"; otherwise authentication won't work."))),Object(r.b)("h3",{id:"access-control"},"Access control"),Object(r.b)("p",null,"Access control in the API is about defining what kind of users (anonymous, authenticated, administrator, etc.)\nmay call (or not) an HTTP entry point."),Object(r.b)("p",null,"In the API, there are three sorts :"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},"Symfony's routes."),Object(r.b)("li",{parentName:"ol"},"GraphQL mutations/queries."),Object(r.b)("li",{parentName:"ol"},"The GraphQL fields.")),Object(r.b)("h4",{id:"symfony-routes-annotations"},"Symfony routes' annotations"),Object(r.b)("p",null,Object(r.b)("em",{parentName:"p"},"Restrict to authenticated users:")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php"}),'use Sensio\\Bundle\\FrameworkExtraBundle\\Configuration\\Security;\nuse Symfony\\Component\\Routing\\Annotation\\Route;\n\n/**\n * @Route("/download/foo", methods={"GET"})\n * @Security("is_granted(\'IS_AUTHENTICATED_FULLY\')")\n */\npublic function downloadFoo(Request $request): Response\n')),Object(r.b)("p",null,Object(r.b)("em",{parentName:"p"},"Restrict to authenticated users with a specific role:")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php"}),'use Sensio\\Bundle\\FrameworkExtraBundle\\Configuration\\Security;\nuse Symfony\\Component\\Routing\\Annotation\\Route;\n\n/**\n * @Route("/download/foo", methods={"GET"})\n * @Security("is_granted(\'ROLE_ADMINISTRATOR\')")\n */\npublic function downloadFoo(Request $request): Response\n')),Object(r.b)("p",null,"See the ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://symfony.com/doc/current/security.html"}),"security")," and\n",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://symfony.com/doc/current/bundles/SensioFrameworkExtraBundle/annotations/security.html"}),"annotations")," documentations\nfrom Symfony for more details."),Object(r.b)("h4",{id:"graphql-annotations"},"GraphQL annotations"),Object(r.b)("p",null,Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://graphqlite.thecodingmachine.io/"}),"GraphQLite")," provides many Symfony like annotations,\n",Object(r.b)("strong",{parentName:"p"},"even if they differ slightly on some occasions"),". The import statements are also different."),Object(r.b)("p",null,Object(r.b)("em",{parentName:"p"},"Restrict to authenticated users:")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php"}),"use TheCodingMachine\\GraphQLite\\Annotations\\Logged;\nuse TheCodingMachine\\GraphQLite\\Annotations\\Mutation;\n\n/**\n * @Mutation\n * @Logged\n */\npublic function updateFoo(\n    string $foo\n))\n")),Object(r.b)("p",null,Object(r.b)("em",{parentName:"p"},"Inject the authenticated user:")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php"}),'use TheCodingMachine\\GraphQLite\\Annotations\\InjectUser;\nuse TheCodingMachine\\GraphQLite\\Annotations\\Logged;\nuse TheCodingMachine\\GraphQLite\\Annotations\\Mutation;\n\n/**\n * @Mutation\n * @Logged\n * @InjectUser(for="$user")\n */\npublic function updateFoo(\n    User $user,\n    string $foo\n)\n')),Object(r.b)("p",null,Object(r.b)("em",{parentName:"p"},"Restrict to authenticated users with a specific role:")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php"}),"use TheCodingMachine\\GraphQLite\\Annotations\\Logged;\nuse TheCodingMachine\\GraphQLite\\Annotations\\Mutation;\nuse TheCodingMachine\\GraphQLite\\Annotations\\Security;\n\n/**\n * @Mutation\n * @Logged\n * @Security(\"is_granted('ROLE_ADMINISTRATOR')\")\n */\npublic function updateFoo(\n    string $foo\n)\n")),Object(r.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(r.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(r.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(r.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(r.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(r.b)("p",{parentName:"div"},"\ud83d\udce3","\xa0","\xa0","Contrary to Symfony's routes, always put the ",Object(r.b)("inlineCode",{parentName:"p"},"@Logged")," annotation before the ",Object(r.b)("inlineCode",{parentName:"p"},"@Security")," and ",Object(r.b)("inlineCode",{parentName:"p"},"@InjectUser")," annotations\non your GraphQL entry points. The web application needs to know the difference between unauthenticated (",Object(r.b)("inlineCode",{parentName:"p"},"401"),")\nand access denied (",Object(r.b)("inlineCode",{parentName:"p"},"403"),")!"))),Object(r.b)("p",null,"See ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://graphqlite.thecodingmachine.io/docs/fine-grained-security"}),"GraphQLite documentation")," for more details."),Object(r.b)("h4",{id:"symfonys-voters"},"Symfony's voters"),Object(r.b)("p",null,"Sometimes it is not enough to restrict access to authenticated users/users with a specific role.\nFor instance, when a resource is only accessible to the user owning it."),Object(r.b)("p",null,"That's when Symfony's voters come in handy!"),Object(r.b)("p",null,"It comes in two parts:"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},"The PHP class which is specifying the voter's rules."),Object(r.b)("li",{parentName:"ol"},"The annotation we put on GraphQL mutations/queries and Symfony's routes.")),Object(r.b)("p",null,"For instance, let's examine the following scenario: a merchant can update a product, but only if his company owns the\nproduct."),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php",metastring:'title="src/api/src/UseCase/Product/UpdateProduct.php"',title:'"src/api/src/UseCase/Product/UpdateProduct.php"'}),"use TheCodingMachine\\GraphQLite\\Annotations\\Logged;\nuse TheCodingMachine\\GraphQLite\\Annotations\\Mutation;\nuse TheCodingMachine\\GraphQLite\\Annotations\\Security;\n\n/**\n * @Mutation\n * @Logged\n * @Security(\"is_granted('UPDATE_PRODUCT', product)\")\n */\npublic function updateProduct(\n    Product $product,\n    string $name,\n    float $price\n): Product\n")),Object(r.b)("p",null,"A voter annotation has two arguments:"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},"The attribute: in our application, it's equivalent to an action, i.e., ",Object(r.b)("inlineCode",{parentName:"li"},"UPDATE_USER"),", ",Object(r.b)("inlineCode",{parentName:"li"},"GET_USER"),", etc."),Object(r.b)("li",{parentName:"ol"},"The subject: mostly the ",Object(r.b)("inlineCode",{parentName:"li"},"Model")," on which we want to check ownership.")),Object(r.b)("p",null,"Here the annotation asks for a voter that may handle the ",Object(r.b)("inlineCode",{parentName:"p"},"UPDATE_PRODUCT")," attribute for the ",Object(r.b)("inlineCode",{parentName:"p"},"$product")," subject."),Object(r.b)("p",null,"By convention, we've created a voter PHP class per subject. In that case, as the subject is a ",Object(r.b)("inlineCode",{parentName:"p"},"Product"),", we've made the\n",Object(r.b)("em",{parentName:"p"},"src/api/src/Infrastructure/Security/Voter/ProductVoter.php")," class."),Object(r.b)("p",null,"Each voters' PHP class consist of three parts:"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},"The attributes constants."),Object(r.b)("li",{parentName:"ol"},"The method ",Object(r.b)("inlineCode",{parentName:"li"},"supports"),": it returns ",Object(r.b)("inlineCode",{parentName:"li"},"true")," if the voter supports both the given attribute and subject."),Object(r.b)("li",{parentName:"ol"},"The method ",Object(r.b)("inlineCode",{parentName:"li"},"voteOnAttribute"),": only called if the ",Object(r.b)("inlineCode",{parentName:"li"},"supports")," method returned ",Object(r.b)("inlineCode",{parentName:"li"},"true"),". It contains your custom logic\nfor validating (or not) the access.")),Object(r.b)("p",null,"Take a closer look at those methods from ",Object(r.b)("inlineCode",{parentName:"p"},"ProductVoter")," for a better understanding."),Object(r.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(r.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(r.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(r.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(r.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(r.b)("p",{parentName:"div"},"\ud83d\udce3","\xa0","\xa0","In your Symfony's routes, you may not have access to a ",Object(r.b)("inlineCode",{parentName:"p"},"Model")," directly but an ",Object(r.b)("inlineCode",{parentName:"p"},"id")," instead.\nThe ",Object(r.b)("em",{parentName:"p"},"src/api/src/Infrastructure/Controller/Order/OrderInvoiceController.php"),"\nand ",Object(r.b)("em",{parentName:"p"},"src/api/src/Infrastructure/Security/Voter/OrderVoter.php")," classes show how to handle that kind of scenario."))),Object(r.b)("h4",{id:"graphql-fields"},"GraphQL fields"),Object(r.b)("p",null,"Usually, you define your GraphQL types' fields in your migrations or your ",Object(r.b)("inlineCode",{parentName:"p"},"Model"),"'s getters in the getters of your\nwhen overriding a base ",Object(r.b)("inlineCode",{parentName:"p"},"Model"),"'s getter. That's when you must decide if you want to expose or not the field\nto your GraphQL clients."),Object(r.b)("p",null,"Also, as you are developing both the clients and the API, securing the entry points should be enough. If that's not the\ncase, you can add the same ",Object(r.b)("inlineCode",{parentName:"p"},"@Security")," annotations to your getters as the ones from the mutations/queries."),Object(r.b)("h3",{id:"cors"},"CORS"),Object(r.b)("p",null,"CORS is the mechanism defining what can interact with the API via HTTP requests."),Object(r.b)("p",null,"The application uses the ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/nelmio/NelmioCorsBundle"}),"nelmio/cors-bundle")," package for that task.\nWe configured this bundle in the configuration file ",Object(r.b)("em",{parentName:"p"},"src/api/config/packages/nelmio_cors.yaml"),"."),Object(r.b)("p",null,"The current configuration only authorizes HTTP requests from the main domain (and the API subdomain)."),Object(r.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(r.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(r.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(r.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(r.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(r.b)("p",{parentName:"div"},"\ud83d\udce3","\xa0","\xa0","Never use ",Object(r.b)("inlineCode",{parentName:"p"},"*")," as ",Object(r.b)("inlineCode",{parentName:"p"},"CORS_ALLOW_ORIGIN")," because it opens your API to the world. As there is no CSRF protection, a\nmalicious hacker will be able to hijack the connexion of one of your authenticated users to do bad things. Also, make sure\nyou don't have XSS vulnerabilities. "))),Object(r.b)("h2",{id:"web-application"},"Web application"),Object(r.b)("p",null,"Security for the web application has many scopes:"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},"Authenticate users."),Object(r.b)("li",{parentName:"ol"},"Retrieve their information (email, first name, etc.)"),Object(r.b)("li",{parentName:"ol"},"Makes sure the GraphQL client gives the ",Object(r.b)("inlineCode",{parentName:"li"},"PHPSESSID")," cookie on server-side requests."),Object(r.b)("li",{parentName:"ol"},"Display or not UI element."),Object(r.b)("li",{parentName:"ol"},"Access control.")),Object(r.b)("h3",{id:"auth-store"},Object(r.b)("inlineCode",{parentName:"h3"},"auth")," store"),Object(r.b)("p",null,"The ",Object(r.b)("em",{parentName:"p"},"src/webapp/store/auth")," store centralizes the data of the authenticated user."),Object(r.b)("p",null,"We use this store in many parts of the security process."),Object(r.b)("p",null,Object(r.b)("strong",{parentName:"p"},"The state:")," ",Object(r.b)("em",{parentName:"p"},"src/webapp/store/auth/state.js")),Object(r.b)("p",null,"It contains a ",Object(r.b)("inlineCode",{parentName:"p"},"user")," object with the following values:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"id")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"firstName")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"lastName")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"email")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"locale")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"role"))),Object(r.b)("p",null,"We initialize these values with empty strings."),Object(r.b)("p",null,Object(r.b)("strong",{parentName:"p"},"Getters:")," ",Object(r.b)("em",{parentName:"p"},"src/webapp/store/auth/getters.js")),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"isAuthenticated"),": it returns ",Object(r.b)("inlineCode",{parentName:"li"},"true")," if the ",Object(r.b)("inlineCode",{parentName:"li"},"user"),"'s ",Object(r.b)("inlineCode",{parentName:"li"},"email")," property from the state is empty. It might return ",Object(r.b)("inlineCode",{parentName:"li"},"true"),"\neven if the user has no more session in the API, but we will see below how to handle such a case."),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"isGranted"),": it returns ",Object(r.b)("inlineCode",{parentName:"li"},"true")," if the user has the access level of the given role. It works as the ",Object(r.b)("inlineCode",{parentName:"li"},"@Security")," annotation\nfrom the API.")),Object(r.b)("p",null,"It would be best to use these getters mostly for displaying (or not) an element in the UI."),Object(r.b)("p",null,Object(r.b)("strong",{parentName:"p"},"Mutations:")," ",Object(r.b)("em",{parentName:"p"},"src/webapp/store/auth/mutations.js")),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"setUser"),": sets the state's ",Object(r.b)("inlineCode",{parentName:"li"},"user")," object."),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"setUserLocale"),": sets the state's ",Object(r.b)("inlineCode",{parentName:"li"},"user"),"'s ",Object(r.b)("inlineCode",{parentName:"li"},"locale")," property."),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"resetUser"),": resets the state's ",Object(r.b)("inlineCode",{parentName:"li"},"user")," object with empty strings.")),Object(r.b)("p",null,Object(r.b)("strong",{parentName:"p"},"Actions:")," ",Object(r.b)("em",{parentName:"p"},"src/webapp/store/auth/actions.js")),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"me"),": calls the ",Object(r.b)("inlineCode",{parentName:"li"},"me")," GraphQL query and, according to the result,\nsets the state's ",Object(r.b)("inlineCode",{parentName:"li"},"user")," object or resets it.")),Object(r.b)("h3",{id:"role-hierarchy"},"Role hierarchy"),Object(r.b)("p",null,"File ",Object(r.b)("em",{parentName:"p"},"src/webapp/services/role-authorization-levels.js")," exposes the ",Object(r.b)("inlineCode",{parentName:"p"},"level")," method. It reproduces Symfony's roles' hierarchy."),Object(r.b)("h3",{id:"authenticate-users"},"Authenticate users"),Object(r.b)("p",null,"On the ",Object(r.b)("em",{parentName:"p"},"src/webapp/pages/login.vue")," page, we call the ",Object(r.b)("inlineCode",{parentName:"p"},"login")," GraphQL mutation. On success, we feed the state\nof the ",Object(r.b)("em",{parentName:"p"},"src/webapp/store/auth")," store, thanks to the ",Object(r.b)("inlineCode",{parentName:"p"},"setUser")," mutation."),Object(r.b)("p",null,"As explained before, the API sets the ",Object(r.b)("inlineCode",{parentName:"p"},"PHPSESSID")," cookie in the browser. "),Object(r.b)("p",null,"When in SPA mode, the browser sets the header ",Object(r.b)("inlineCode",{parentName:"p"},"Cookie")," with the ",Object(r.b)("inlineCode",{parentName:"p"},"PHPSESSID")," on each HTTP request to the API. "),Object(r.b)("p",null,"However, the first time the user lands on the application, Nuxt.js server-renders the current page. It also renders pages\nhaving the ",Object(r.b)("inlineCode",{parentName:"p"},"asyncData")," attribute on the server."),Object(r.b)("p",null,"In the file ",Object(r.b)("em",{parentName:"p"},"src/webapp/store/actions.js"),",\nthere is an ",Object(r.b)("inlineCode",{parentName:"p"},"nuxtServerInit")," method, which Nuxt.js calls before server-rendering every page.\nIn this function, we:"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},"Set the header ",Object(r.b)("inlineCode",{parentName:"li"},"Cookie")," for every server-side GraphQL requests."),Object(r.b)("li",{parentName:"ol"},"Call the ",Object(r.b)("inlineCode",{parentName:"li"},"me")," action to fetch (or not) the user data (useful when the user refreshes the page).")),Object(r.b)("h3",{id:"access-control-1"},"Access control"),Object(r.b)("p",null,"The ",Object(r.b)("em",{parentName:"p"},"src/webapp/layouts/error.vue")," layout handles almost every error."),Object(r.b)("p",null,"You can propagate a GraphQL error via ",Object(r.b)("inlineCode",{parentName:"p"},"context.error(e)")," in the ",Object(r.b)("inlineCode",{parentName:"p"},"asyncData")," component's attribute or ",Object(r.b)("inlineCode",{parentName:"p"},"this.$nuxt.error(e)"),"\nin your component's methods (except mixins, where you have to throw it)."),Object(r.b)("p",null,"In the error layout, we check if:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"401")," status code: the user has no session in the API. Therefore, we call the ",Object(r.b)("inlineCode",{parentName:"li"},"resetUser")," mutation and redirect the\nuser to the login page. On success, the web application redirects the user to the current page thanks to the ",Object(r.b)("inlineCode",{parentName:"li"},"redirect"),"\nquery parameter. "),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"404"),", ",Object(r.b)("inlineCode",{parentName:"li"},"403"),", or anything else: we display an error page.")),Object(r.b)("p",null,"Some pages are also not available for the authenticated user (for instance, the login page).\nYou may use the ",Object(r.b)("em",{parentName:"p"},"src/webapp/middleware/redirect-if-authenticated.js")," middleware to redirect the user to the home page:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-vue",metastring:'title="src/webapp/pages/login.vue"',title:'"src/webapp/pages/login.vue"'}),"export default {\n  middleware: ['redirect-if-authenticated'],\n}\n")))}b.isMDXComponent=!0},91:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return h}));var a=n(0),i=n.n(a);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=i.a.createContext({}),b=function(e){var t=i.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):c(c({},t),e)),n},p=function(e){var t=b(e.components);return i.a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return i.a.createElement(i.a.Fragment,{},t)}},m=i.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,o=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),p=b(n),m=a,h=p["".concat(o,".").concat(m)]||p[m]||u[m]||r;return n?i.a.createElement(h,c(c({ref:t},l),{},{components:n})):i.a.createElement(h,c({ref:t},l))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,o=new Array(r);o[0]=m;var c={};for(var s in t)hasOwnProperty.call(t,s)&&(c[s]=t[s]);c.originalType=e,c.mdxType="string"==typeof e?e:a,o[1]=c;for(var l=2;l<r;l++)o[l]=n[l];return i.a.createElement.apply(null,o)}return i.a.createElement.apply(null,n)}m.displayName="MDXCreateElement"}}]);